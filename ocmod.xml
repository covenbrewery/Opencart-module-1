<?xml version="1.0" encoding="utf-8"?>
<modification>
	<name>Unishop2 Fix: Advanced Order Info (v6)</name>
	<code>unishop2_fix_order_info_v6</code>
	<version>6.0.0</version>
	<author>unishop2_fix</author>

	<file path="catalog/controller/account/order.php">
		<!-- Load models we need -->
		<operation>
			<search><![CDATA[$this->load->model('tool/upload');]]></search>
			<add position="after"><![CDATA[
			$this->load->model('tool/image');
			]]></add>
		</operation>

		<!-- Add AJAX url to template data -->
		<operation>
			<search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
			<add position="after"><![CDATA[
			$data['uni2fix_requestdoc'] = $this->url->link('account/order/requestdoc', '', true);
			]]></add>
		</operation>

		<!-- Init stats accumulators -->
		<operation>
			<search><![CDATA[$data['products'] = array();]]></search>
			<add position="after"><![CDATA[

			$uni2fix_sum_weight_kg = 0.0;
			$uni2fix_sum_volume_m3 = 0.0;
			$uni2fix_sum_liters = 0.0;
			$uni2fix_boxes = 0;
			$uni2fix_boxes_approx = false;

			$uni2fix_wc_id = (int)$this->config->get('config_weight_class_id');
			$uni2fix_lc_id = (int)$this->config->get('config_length_class_id');

			// Units from libraries (no localisation models)
			$uni2fix_wc_unit = '';
			$uni2fix_lc_unit = '';

			if (isset($this->weight) && method_exists($this->weight, 'getUnit')) {
				$uni2fix_wc_unit = $this->weight->getUnit($uni2fix_wc_id);
			}
			if (isset($this->length) && method_exists($this->length, 'getUnit')) {
				$uni2fix_lc_unit = $this->length->getUnit($uni2fix_lc_id);
			}

			$uni2fix_wc_unit = utf8_strtolower(trim((string)$uni2fix_wc_unit));
			$uni2fix_lc_unit = utf8_strtolower(trim((string)$uni2fix_lc_unit));

			// Normalize RU units
			if ($uni2fix_wc_unit === 'кг') $uni2fix_wc_unit = 'kg';
			if ($uni2fix_wc_unit === 'г') $uni2fix_wc_unit = 'g';
			if ($uni2fix_lc_unit === 'см') $uni2fix_lc_unit = 'cm';
			if ($uni2fix_lc_unit === 'мм') $uni2fix_lc_unit = 'mm';
			if ($uni2fix_lc_unit === 'м') $uni2fix_lc_unit = 'm';

			// conversion factors (store unit -> kg / meter)
			$uni2fix_wc_to_kg = 1.0;
			if ($uni2fix_wc_unit === 'g') { $uni2fix_wc_to_kg = 0.001; }
			elseif ($uni2fix_wc_unit === 'kg') { $uni2fix_wc_to_kg = 1.0; }
			elseif ($uni2fix_wc_unit === 'lb') { $uni2fix_wc_to_kg = 0.45359237; }
			elseif ($uni2fix_wc_unit === 'oz') { $uni2fix_wc_to_kg = 0.0283495231; }

			$uni2fix_lc_to_m = 0.01; // default assume cm
			if ($uni2fix_lc_unit === 'mm') { $uni2fix_lc_to_m = 0.001; }
			elseif ($uni2fix_lc_unit === 'cm') { $uni2fix_lc_to_m = 0.01; }
			elseif ($uni2fix_lc_unit === 'm') { $uni2fix_lc_to_m = 1.0; }
			elseif ($uni2fix_lc_unit === 'in') { $uni2fix_lc_to_m = 0.0254; }
			elseif ($uni2fix_lc_unit === 'ft') { $uni2fix_lc_to_m = 0.3048; }

			]]></add>
		</operation>

		<!-- Enrich product row data + accumulate stats -->
		<operation>
			<search><![CDATA[$product_info = $this->model_catalog_product->getProduct($product['product_id']);]]></search>
			<add position="after"><![CDATA[
				$thumb = '';
				$image = '';
				$sku = '';
				$upc_full = '';
				$upc_short = '';
				$isbn = '';
				$ean = '';
				$declaration_url = '';

				$server = (!empty($this->request->server['HTTPS']) && ($this->request->server['HTTPS'] == 'on' || $this->request->server['HTTPS'] == '1')) ? $this->config->get('config_ssl') : $this->config->get('config_url');

				if ($product_info) {
					// Images
					if (!empty($product_info['image'])) {
						$thumb = $this->model_tool_image->resize($product_info['image'], 60, 60);
						$image = $server . 'image/' . $product_info['image'];
					}

					// SKU/UPC/ISBN/EAN
					$sku = isset($product_info['sku']) ? $product_info['sku'] : '';
					$upc_full = isset($product_info['upc']) ? html_entity_decode($product_info['upc'], ENT_QUOTES, 'UTF-8') : '';
					$upc_short = $upc_full;

					// Extract text between quotes for "tech name"
					if (strpos($upc_full, '"') !== false) {
						$p1 = strpos($upc_full, '"');
						$p2 = strpos($upc_full, '"', $p1 + 1);
						if ($p2 !== false && $p2 > $p1) {
							$upc_short = trim(substr($upc_full, $p1 + 1, $p2 - $p1 - 1));
						}
					} elseif (strpos($upc_full, '«') !== false && strpos($upc_full, '»') !== false) {
						$p1 = strpos($upc_full, '«');
						$p2 = strpos($upc_full, '»', $p1 + 1);
						if ($p2 !== false && $p2 > $p1) {
							$upc_short = trim(substr($upc_full, $p1 + 1, $p2 - $p1 - 1));
						}
					} elseif (strpos($upc_full, '“') !== false && strpos($upc_full, '”') !== false) {
						$p1 = strpos($upc_full, '“');
						$p2 = strpos($upc_full, '”', $p1 + 1);
						if ($p2 !== false && $p2 > $p1) {
							$upc_short = trim(substr($upc_full, $p1 + 1, $p2 - $p1 - 1));
						}
					}

					$isbn = isset($product_info['isbn']) ? $product_info['isbn'] : '';
					$ean = isset($product_info['ean']) ? $product_info['ean'] : '';

					// Declaration PDF path: /download/deklaracii/{manufacturer}/{numbers-numbers}.pdf (extension case-insensitive)
					$manufacturer = isset($product_info['manufacturer']) ? $product_info['manufacturer'] : '';
					$manufacturer_folder = str_replace(array('/', '\\', ':', '*', '?', '"', '<', '>', '|'), '', $manufacturer);

					$decl_code = '';
					if ($isbn && preg_match('/(\d+)\s*\/\s*(\d+)/u', $isbn, $m)) {
						$decl_code = $m[1] . '-' . $m[2];
					}

					if ($decl_code && $manufacturer_folder) {
						$root = dirname(DIR_APPLICATION);
						$decl_dir = $root . '/download/deklaracii/' . $manufacturer_folder . '/';
						if (is_dir($decl_dir)) {
							$candidates = glob($decl_dir . $decl_code . '.*');
							if ($candidates) {
								foreach ($candidates as $file) {
									if (is_file($file)) {
										$ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
										if ($ext === 'pdf') {
											$declaration_url = $server . 'download/deklaracii/' . rawurlencode($manufacturer_folder) . '/' . rawurlencode(basename($file));
											break;
										}
									}
								}
							}
							if (!$declaration_url) {
								$f = $decl_dir . $decl_code . '.pdf';
								if (is_file($f)) {
									$declaration_url = $server . 'download/deklaracii/' . rawurlencode($manufacturer_folder) . '/' . rawurlencode(basename($f));
								}
							}
						}
					}

					// ===== Stats: weight (kg), volume (m3), liters, boxes =====
					$qty = (float)$product['quantity'];

					// Weight to kg
					$w_store = (isset($this->weight) && method_exists($this->weight, 'convert')) ? $this->weight->convert((float)$product_info['weight'], (int)$product_info['weight_class_id'], $uni2fix_wc_id) : (float)$product_info['weight'];
										$w_kg = $w_store * $uni2fix_wc_to_kg;
					$uni2fix_sum_weight_kg += ($w_kg * $qty);

					// Volume to m3 (convert dims to store length unit first)
					$len = (isset($this->length) && method_exists($this->length, 'convert')) ? $this->length->convert((float)$product_info['length'], (int)$product_info['length_class_id'], $uni2fix_lc_id) : (float)$product_info['length'];
					$wid = (isset($this->length) && method_exists($this->length, 'convert')) ? $this->length->convert((float)$product_info['width'], (int)$product_info['length_class_id'], $uni2fix_lc_id) : (float)$product_info['width'];
					$hei = (isset($this->length) && method_exists($this->length, 'convert')) ? $this->length->convert((float)$product_info['height'], (int)$product_info['length_class_id'], $uni2fix_lc_id) : (float)$product_info['height'];

					$len_m = $len; $wid_m = $wid; $hei_m = $hei;
					if ($uni2fix_lc_unit === 'mm') { $len_m = $len / 1000; $wid_m = $wid / 1000; $hei_m = $hei / 1000; }
					elseif ($uni2fix_lc_unit === 'cm') { $len_m = $len / 100; $wid_m = $wid / 100; $hei_m = $hei / 100; }
					elseif ($uni2fix_lc_unit === 'm') { $len_m = $len; $wid_m = $wid; $hei_m = $hei; }
					elseif ($uni2fix_lc_unit === 'in') { $len_m = $len * 0.0254; $wid_m = $wid * 0.0254; $hei_m = $hei * 0.0254; }
					elseif ($uni2fix_lc_unit === 'ft') { $len_m = $len * 0.3048; $wid_m = $wid * 0.3048; $hei_m = $hei * 0.3048; }

					$vol = $len_m * $wid_m * $hei_m;
					if ($vol > 0) {
						$uni2fix_sum_volume_m3 += ($vol * $qty);
					}

					// Liters from name: ... 0,45л / 20л / 0.5л
					$lit = 0.0;
					if (preg_match('/([0-9]+(?:[\.,][0-9]+)?)\s*л/iu', $product['name'], $lm)) {
						$lit = (float)str_replace(',', '.', $lm[1]);
					}
					$uni2fix_sum_liters += ($lit * $qty);

					// Boxes estimate
					$name_l = utf8_strtolower($product['name']);
					if (strpos($name_l, 'кег') !== false) {
						$uni2fix_boxes += (int)$product['quantity'];
					} elseif (strpos($name_l, 'банка') !== false || strpos($name_l, 'бутылка') !== false) {
						$pack = 0;
						$attrs = $this->model_catalog_product->getProductAttributes($product['product_id']);
						if ($attrs) {
							foreach ($attrs as $ag) {
								if (!empty($ag['attribute'])) {
									foreach ($ag['attribute'] as $a) {
										if ((int)$a['attribute_id'] === 21) {
											$txt = html_entity_decode($a['text'], ENT_QUOTES, 'UTF-8');
											if (preg_match('/(\d+)/', $txt, $mm)) {
												$pack = (int)$mm[1];
											}
											break 2;
										}
									}
								}
							}
						}

						$q = (int)$product['quantity'];
						if ($pack > 0) {
							$full = intdiv($q, $pack);
							$rem = $q % $pack;
							$uni2fix_boxes += $full + ($rem > 0 ? 1 : 0);
							if ($rem > 0) {
								$uni2fix_boxes_approx = true;
							}
						} else {
							// no pack attribute => approximate
							$uni2fix_boxes += 1;
							$uni2fix_boxes_approx = true;
						}
					} else {
						// Unknown packaging => approximate
						$uni2fix_boxes += 1;
						$uni2fix_boxes_approx = true;
					}
				}
			]]></add>
		</operation>

		<!-- Inject extra keys into products array -->
		<operation>
			<search><![CDATA['return'   => $this->url->link('account/return/add', 'order_id=' . $order_info['order_id'] . '&return_product_id=' . $product['product_id'], true)]]></search>
			<add position="replace"><![CDATA['return'   => $this->url->link('account/return/add', 'order_id=' . $order_info['order_id'] . '&return_product_id=' . $product['product_id'], true),
					'order_product_id' => (int)$product['order_product_id'],
					'thumb'    => $thumb,
					'image'    => $image,
					'sku'      => $sku,
					'upc_full' => $upc_full,
					'upc_short'=> $upc_short,
					'isbn'     => $isbn,
					'ean'      => $ean,
					'declaration_url' => $declaration_url]]></add>
		</operation>

		<!-- Expose stats to template -->
		<operation>
			<search><![CDATA[// Voucher]]></search>
			<add position="before"><![CDATA[
			$data['uni2fix_stats'] = array(
				'weight_kg' => (float)round($uni2fix_sum_weight_kg, 3),
				'volume_m3' => (float)round($uni2fix_sum_volume_m3, 4),
				'liters'    => (float)round($uni2fix_sum_liters, 2),
				'boxes'     => (int)$uni2fix_boxes,
				'boxes_approx' => $uni2fix_boxes_approx ? true : false
			);
			]]></add>
		</operation>

		<!-- Use custom template -->
		<operation>
			<search><![CDATA[$this->response->setOutput($this->load->view('account/order_info', $data));]]></search>
			<add position="replace"><![CDATA[$this->response->setOutput($this->load->view('extension/unishop2_fix/account/order_info', $data));]]></add>
		</operation>

		<!-- AJAX handler to send request email to admin -->
		<operation>
			<search><![CDATA[public function reorder() {]]></search>
			<add position="before"><![CDATA[
	public function requestdoc() {
		$json = array();

		if (!$this->customer->isLogged()) {
			$json['error'] = 'Требуется авторизация';
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		$order_id = isset($this->request->post['order_id']) ? (int)$this->request->post['order_id'] : 0;
		$order_product_id = isset($this->request->post['order_product_id']) ? (int)$this->request->post['order_product_id'] : 0;
		$kind = isset($this->request->post['kind']) ? (string)$this->request->post['kind'] : '';

		if (!$order_id || !$order_product_id) {
			$json['error'] = 'Некорректные данные';
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		$this->load->model('account/order');
		$this->load->model('catalog/product');

		$order_info = $this->model_account_order->getOrder($order_id);
		if (!$order_info || (int)$order_info['customer_id'] !== (int)$this->customer->getId()) {
			$json['error'] = 'Заказ не найден';
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		$order_products = $this->model_account_order->getOrderProducts($order_id);
		$op = null;
		foreach ($order_products as $p) {
			if ((int)$p['order_product_id'] === $order_product_id) { $op = $p; break; }
		}

		if (!$op) {
			$json['error'] = 'Товар не найден в заказе';
			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
			return;
		}

		$product_info = $this->model_catalog_product->getProduct($op['product_id']);

		$customer_line = trim($order_info['firstname'] . ' ' . $order_info['lastname']);
		if (!empty($order_info['payment_company'])) {
			$customer_line .= ' (' . $order_info['payment_company'] . ')';
		}

		$need = 'Документ';
		if ($kind === 'declaration_text') $need = 'Декларацию';
		if ($kind === 'declaration_pdf') $need = 'PDF декларации';
		if ($kind === 'ean') $need = 'Штрихкод (EAN)';

		$sku = ($product_info && isset($product_info['sku'])) ? $product_info['sku'] : '';

		$message = "Покупатель: " . $customer_line . "\n";
		$message .= "ID покупателя: " . (int)$order_info['customer_id'] . "\n\n";
		$message .= "Заказ: #" . (int)$order_id . "\n\n";
		$message .= "Товар: " . $op['name'] . "\n";
		$message .= "ID товара: " . (int)$op['product_id'] . "\n";
		$message .= "SKU: " . $sku . "\n\n";
		$message .= "Просьба предоставить: " . $need . "\n";

		try {
			$mail = new Mail($this->config->get('config_mail_engine'));
			$mail->parameter = $this->config->get('config_mail_parameter');
			$mail->smtp_hostname = $this->config->get('config_mail_smtp_hostname');
			$mail->smtp_username = $this->config->get('config_mail_smtp_username');
			$mail->smtp_password = html_entity_decode($this->config->get('config_mail_smtp_password'), ENT_QUOTES, 'UTF-8');
			$mail->smtp_port = $this->config->get('config_mail_smtp_port');
			$mail->smtp_timeout = $this->config->get('config_mail_smtp_timeout');

			$mail->setTo($this->config->get('config_email'));
			$mail->setFrom($this->config->get('config_email'));
			$mail->setSender(html_entity_decode($this->config->get('config_name'), ENT_QUOTES, 'UTF-8'));
			$mail->setSubject('Запрос документов по заказу #' . (int)$order_id);
			$mail->setText($message);
			$mail->send();

			$json['success'] = true;
		} catch (Exception $e) {
			$json['error'] = 'Ошибка отправки';
		}

		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));
	}
			]]></add>
		</operation>
	</file>
</modification>
